
<div class="root"><span class="header">Heroes</span>
  <fieldset class="repeating_heroes">
    <div class="hero">
      <div class="hero-3-cell"><span class="block-label">Name</span>
        <input type="text" name="attr_name" value=""/>
      </div>
      <div class="hero-3-cell"><span class="block-label">Occupation</span>
        <input type="text" name="attr_occupation" value=""/>
      </div>
      <div class="hero-3-cell"><span class="block-label">Alignment</span>
        <select name="attr_alignment">
          <option value="&lt;Select an alignment&gt;">&lt;Select an alignment&gt;</option>
          <option value="Lawful">Lawful</option>
          <option value="Neutral">Neutral</option>
          <option value="Chaotic">Chaotic</option>
        </select>
      </div>
      <div class="hero-1-cell"></div>
      <div class="hero-3-cell"><span class="block-label">Class</span>
        <select name="attr_class">
          <option value="None">None</option>
          <option value="Cleric">Cleric</option>
          <option value="Thief">Thief</option>
          <option value="Warrior">Warrior</option>
          <option value="Wizard">Wizard</option>
          <option value="Dwarf">Dwarf</option>
          <option value="Elf">Elf</option>
          <option value="Halfling">Halfling</option>
        </select>
      </div>
      <div class="hero-3-cell"><span class="block-label">Title</span>
        <input type="text" name="attr_title" value="Peasant"/>
      </div>
      <div class="hero-2-cell"><span class="block-label">Experience</span>
        <input type="number" style="width:140px;" name="attr_experience" value="0"/>
      </div>
      <div class="hero-1-cell"><span class="block-label">Level</span>
        <input type="number" name="attr_level" value="0"/>
      </div>
      <div class="hero-1-cell"></div>
      <div class="hero-stat-cell" style="background-image: url('https://raw.githubusercontent.com/ejrinkus/roll20-character-sheets/funnels-and-followers/DCC_Funnels_And_Followers/assets/icons/heart.png')">
        <input class="stat" type="number" name="attr_hp" value="0"/>
        <input class="stat-mod" type="number" name="attr_hpmax" value="0" readonly="readonly"/>
      </div>
      <div class="hero-stat-cell" style="background-image: url('https://raw.githubusercontent.com/ejrinkus/roll20-character-sheets/funnels-and-followers/DCC_Funnels_And_Followers/assets/icons/shield.png')">
        <input class="stat standalone" type="number" name="attr_ac" value="10" readonly="readonly"/>
      </div>
      <div class="hero-stat-cell" style="background-image: url('https://raw.githubusercontent.com/ejrinkus/roll20-character-sheets/funnels-and-followers/DCC_Funnels_And_Followers/assets/icons/movement.png')">
        <input class="stat standalone" type="number" name="attr_movement" value="30" readonly="readonly"/>
      </div>
      <div class="hero-stat-cell" style="background-image: url('https://raw.githubusercontent.com/ejrinkus/roll20-character-sheets/funnels-and-followers/DCC_Funnels_And_Followers/assets/icons/initiative.png')">
        <input class="stat standalone" type="number" name="attr_initiative" value="0" readonly="readonly"/>
      </div>
      <div class="hero-stat-cell" style="background-image: url('https://raw.githubusercontent.com/ejrinkus/roll20-character-sheets/funnels-and-followers/DCC_Funnels_And_Followers/assets/icons/strength.png')">
        <input class="stat standalone" type="number" name="attr_strengthmod" value="0" readonly="readonly"/>
      </div>
      <div class="hero-stat-cell" style="background-image: url('https://raw.githubusercontent.com/ejrinkus/roll20-character-sheets/funnels-and-followers/DCC_Funnels_And_Followers/assets/icons/stamina.png')">
        <input class="stat standalone" type="number" name="attr_staminamod" value="0" readonly="readonly"/>
      </div>
      <div class="hero-stat-cell" style="background-image: url('https://raw.githubusercontent.com/ejrinkus/roll20-character-sheets/funnels-and-followers/DCC_Funnels_And_Followers/assets/icons/agility.png')">
        <input class="stat standalone" type="number" name="attr_agilitymod" value="0" readonly="readonly"/>
      </div>
      <div class="hero-stat-cell" style="background-image: url('https://raw.githubusercontent.com/ejrinkus/roll20-character-sheets/funnels-and-followers/DCC_Funnels_And_Followers/assets/icons/personality.png')">
        <input class="stat standalone" type="number" name="attr_personalitymod" value="0" readonly="readonly"/>
      </div>
      <div class="hero-stat-cell" style="background-image: url('https://raw.githubusercontent.com/ejrinkus/roll20-character-sheets/funnels-and-followers/DCC_Funnels_And_Followers/assets/icons/intelligence.png')">
        <input class="stat standalone" type="number" name="attr_intelligencemod" value="0" readonly="readonly"/>
      </div>
      <div class="hero-stat-cell" style="background-image: url('https://raw.githubusercontent.com/ejrinkus/roll20-character-sheets/funnels-and-followers/DCC_Funnels_And_Followers/assets/icons/luck.png')">
        <input class="stat standalone" type="number" name="attr_luckmod" value="0" readonly="readonly"/>
      </div>
      <div class="hero-label-cell"><span class="block-label">HP</span></div>
      <div class="hero-label-cell"><span class="block-label">AC</span></div>
      <div class="hero-label-cell"><span class="block-label">MOV</span></div>
      <div class="hero-label-cell"><span class="block-label">INI</span></div>
      <div class="hero-label-cell"><span class="block-label">STR</span></div>
      <div class="hero-label-cell"><span class="block-label">STA</span></div>
      <div class="hero-label-cell"><span class="block-label">AGI</span></div>
      <div class="hero-label-cell"><span class="block-label">PER</span></div>
      <div class="hero-label-cell"><span class="block-label">INT</span></div>
      <div class="hero-label-cell"><span class="block-label">LUC</span></div>
      <div class="wrap-hero-details">
        <input class="toggle" type="checkbox"/><span>&nbsp;Details</span>
        <div class="contents">
          <div class="hero-details">
            <div class="hero-details-buttons">
              <button class="details-button" type="action" name="act_selectvitals">Vitals</button>
              <button class="details-button" type="action" name="act_selectinventory">Inventory</button>
              <button class="details-button" type="action" name="act_selectstatus">Status</button>
              <button class="details-button" type="action" name="act_selectabilities">Abilities</button>
              <button class="details-button" type="action" name="act_selectspellcasting">Spellcasting</button>
            </div>
            <input class="toggle" type="hidden" name="attr_selectvitals"/>
            <div class="hero-details-content">
              <div class="vitals"><span class="inline-label vitals-label">Saves:</span>
                <input type="number" name="attr_forsave" value="0" readonly="readonly"/>
                <input type="number" name="attr_refsave" value="0" readonly="readonly"/>
                <input type="number" name="attr_wilsave" value="0" readonly="readonly"/><span class="spacer">&nbsp;</span><span>&nbsp;</span><span>FOR</span><span>REF</span><span>WIL</span><span class="spacer">&nbsp;</span><span class="spacer">&nbsp;</span><span class="inline-label vitals-label">Rolled HP:</span>
                <input type="number" name="attr_basehp0" value="0"/>
                <input type="number" name="attr_basehp1" value="0"/>
                <input type="number" name="attr_basehp2" value="0"/>
                <input type="number" name="attr_basehp3" value="0"/>
                <input type="number" name="attr_basehp4" value="0"/>
                <input type="number" name="attr_basehp5" value="0"/>
                <input type="number" name="attr_basehp6" value="0"/>
                <input type="number" name="attr_basehp7" value="0"/>
                <input type="number" name="attr_basehp8" value="0"/>
                <input type="number" name="attr_basehp9" value="0"/>
                <input type="number" name="attr_basehp10" value="0"/>
                <input type="number" name="attr_basehptotal" value="0" readonly="readonly"/><span>&nbsp;</span><span>Lvl 0</span><span>Lvl 1</span><span>Lvl 2</span><span>Lvl 3</span><span>Lvl 4</span><span>Lvl 5</span><span>Lvl 6</span><span>Lvl 7</span><span>Lvl 8</span><span>Lvl 9</span><span>Lvl 10</span><span>Total</span><span class="spacer">&nbsp;</span><span class="inline-label vitals-label">Birth Augur:</span>
                <input type="number" name="attr_augurmod" value="0"/>
                <input type="number" name="attr_augurroll" value="0"/>
                <input class="augur" type="text" name="attr_augur" value="" readonly="readonly"/><span>&nbsp;</span><span>Mod</span><span>Roll</span>
                <input class="augur-roll" type="hidden" name="attr_augurroll"/><span class="augur-note-if-healing">*If a cleric, applies to all healing the cleric performs.  Otherwise, applies to all magical healing received from other sources.</span><span class="augur-note-if-crit">**Luck normally affects critical hits and fumbles.  On this result, the modifier is doubled for purposes of crits or fumbles.</span><span class="spacer">&nbsp;</span><span class="inline-label vitals-label">Base Scores:</span>
                <input type="number" name="attr_strengthbase" value="0"/>
                <input type="number" name="attr_staminabase" value="0"/>
                <input type="number" name="attr_agilitybase" value="0"/>
                <input type="number" name="attr_personalitybase" value="0"/>
                <input type="number" name="attr_intelligencebase" value="0"/>
                <input type="number" name="attr_luckbase" value="0"/><span class="spacer">&nbsp;</span><span class="inline-label vitals-label">+/-:</span>
                <input type="number" name="attr_strengthbonus" value="0"/>
                <input type="number" name="attr_staminabonus" value="0"/>
                <input type="number" name="attr_agilitybonus" value="0"/>
                <input type="number" name="attr_personalitybonus" value="0"/>
                <input type="number" name="attr_intelligencebonus" value="0"/>
                <input type="number" name="attr_luckbonus" value="0"/><span class="spacer">&nbsp;</span><span class="inline-label vitals-label">Totals:</span>
                <input type="number" name="attr_strength" value="0" readonly="readonly"/>
                <input type="number" name="attr_stamina" value="0" readonly="readonly"/>
                <input type="number" name="attr_agility" value="0" readonly="readonly"/>
                <input type="number" name="attr_personality" value="0" readonly="readonly"/>
                <input type="number" name="attr_intelligence" value="0" readonly="readonly"/>
                <input type="number" name="attr_luck" value="0" readonly="readonly"/><span class="spacer">&nbsp;</span><span>&nbsp;</span><span>STR</span><span>STA</span><span>AGI</span><span>PER</span><span>INT</span><span>LUC</span><span class="spacer">&nbsp;</span><span class="spacer">&nbsp;</span>
              </div>
            </div>
            <input class="toggle" type="hidden" name="attr_selectinventory"/>
            <div class="hero-details-content">
              <div class="inventory"><span class="block-label">Armor</span>
                <div class="armor-form"><span>Name</span><span>AC</span><span>Checks</span><span>Speed</span><span>Fumble Die</span><span>Value</span>
                  <input type="text" name="attr_armorname"/>
                  <input type="number" name="attr_armoracbonus"/>
                  <input type="number" name="attr_armorcheckpenalty"/>
                  <input type="number" name="attr_armorspeedpenalty"/>
                  <select name="attr_armorfumbledie">
                    <option value="d4">d3</option>
                    <option value="d4">d4</option>
                    <option value="d4">d5</option>
                    <option value="d4">d6</option>
                    <option value="d4">d7</option>
                    <option value="d4">d8</option>
                    <option value="d4">d10</option>
                    <option value="d4">d12</option>
                    <option value="d4">d14</option>
                    <option value="d4">d16</option>
                    <option value="d4">d20</option>
                    <option value="d4">d24</option>
                    <option value="d4">d30</option>
                  </select>
                  <input type="number" name="attr_armorvalue"/><span class="spacer"></span>
                </div><span class="block-label">Weapons</span>
                <div class="weapon-form"><span>Name</span><span>Damage</span><span>Sneak Damage</span><span>Range</span><span>Value</span>
                  <input type="text" name="attr_weaponname0"/>
                  <input class="damage" type="text" name="attr_weapondamage0"/>
                  <input class="damage" type="text" name="attr_weaponsneakdamage0"/>
                  <input class="damage" type="text" name="attr_weaponrange0"/>
                  <input type="number" name="attr_weaponvalue0"/>
                  <div>
                    <input type="checkbox" name="attr_weapon2h0"/><span>&nbsp;Two-Handed?</span>
                  </div>
                  <div>
                    <input type="checkbox" name="attr_weaponthrown0"/><span>&nbsp;Thrown?</span>
                  </div>
                  <div>
                    <input type="checkbox" name="attr_weaponsubdual0"/><span>&nbsp;Subdual?</span>
                  </div>
                  <div>
                    <input type="checkbox" name="attr_weaponmount0"/><span>&nbsp;Mount Weapon?</span>
                  </div><span></span><span class="spacer"></span><span>Name</span><span>Damage</span><span>Sneak Damage</span><span>Range</span><span>Value</span>
                  <input type="text" name="attr_weaponname1"/>
                  <input class="damage" type="text" name="attr_weapondamage1"/>
                  <input class="damage" type="text" name="attr_weaponsneakdamage1"/>
                  <input class="damage" type="text" name="attr_weaponrange1"/>
                  <input type="number" name="attr_weaponvalue1"/>
                  <div>
                    <input type="checkbox" name="attr_weapon2h1"/><span>&nbsp;Two-Handed?</span>
                  </div>
                  <div>
                    <input type="checkbox" name="attr_weaponthrown1"/><span>&nbsp;Thrown?</span>
                  </div>
                  <div>
                    <input type="checkbox" name="attr_weaponsubdual1"/><span>&nbsp;Subdual?</span>
                  </div>
                  <div>
                    <input type="checkbox" name="attr_weaponmount1"/><span>&nbsp;Mount Weapon?</span>
                  </div><span></span><span class="spacer"></span><span>Name</span><span>Damage</span><span>Sneak Damage</span><span>Range</span><span>Value</span>
                  <input type="text" name="attr_weaponname2"/>
                  <input class="damage" type="text" name="attr_weapondamage2"/>
                  <input class="damage" type="text" name="attr_weaponsneakdamage2"/>
                  <input class="damage" type="text" name="attr_weaponrange2"/>
                  <input type="number" name="attr_weaponvalue2"/>
                  <div>
                    <input type="checkbox" name="attr_weapon2h2"/><span>&nbsp;Two-Handed?</span>
                  </div>
                  <div>
                    <input type="checkbox" name="attr_weaponthrown2"/><span>&nbsp;Thrown?</span>
                  </div>
                  <div>
                    <input type="checkbox" name="attr_weaponsubdual2"/><span>&nbsp;Subdual?</span>
                  </div>
                  <div>
                    <input type="checkbox" name="attr_weaponmount2"/><span>&nbsp;Mount Weapon?</span>
                  </div><span></span><span class="spacer"></span>
                </div><span class="block-label">Other Possessions</span>
                <div class="miscellaneous">
                  <textarea name="attr_inventoryplaceholder"></textarea>
                </div>
              </div>
            </div>
            <input class="toggle" type="hidden" name="attr_selectstatus"/>
            <div class="hero-details-content">
              <div class="status">TODO: Implement status form
                <textarea name="attr_statusplaceholder"></textarea>
              </div>
            </div>
            <input class="toggle" type="hidden" name="attr_selectabilities"/>
            <div class="hero-details-content">
              <div class="abilities">TODO: Implement abilities form
                <textarea name="attr_abilitiesplaceholder"></textarea>
              </div>
            </div>
            <input class="toggle" type="hidden" name="attr_selectspellcasting"/>
            <div class="hero-details-content">
              <div class="spells">TODO: Implement spells form
                <textarea name="attr_spellsplaceholder"></textarea>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </fieldset>
</div>
<script type="text/worker">
  
  const fields = ['selectvitals', 'selectinventory', 'selectstatus', 'selectabilities', 'selectspellcasting'];
  on(fields.map(f => `clicked:repeating_heroes:${f}`).join(' '), function(eventInfo) {
      const trigger = eventInfo.sourceAttribute.split('_');
      const thisfield = trigger[3];
      const output = {};
      fields.forEach(f => {
          output['repeating_heroes_' + f] = false;
      });
      output['repeating_heroes_' + thisfield] = true;
      setAttrs(output);
  });
  // Constant prefix due to the fact that all attributes are inside a repeating section.
  const prefix = "repeating_heroes";

  // List of the 6 primary ability scores.
  const abilityScores = ["strength",
    "stamina",
    "agility",
    "personality",
    "intelligence",
    "luck"];

  // List of all the birth augur descriptions, indexed by the d30 roll that they're mapped to.
  const birthAugurs = [
    "<-- Enter your birth augur roll",
    "Harsh winter: All attack rolls",
    "The bull: Melee attack rolls",
    "Fortunate date: Missile fire attack rolls",
    "Raised by wolves: Unarmed attack rolls",
    "Conceived on horseback: Mounted attack rolls",
    "Born on the battlefield: Damage rolls",
    "Path of the bear: Melee damage rolls",
    "Hawkeye: Missile fire damage rolls",
    "Pack hunter: Attack and damage rolls for 0-level starting weapon",
    "Born under the loom: Skill checks (including thief skills)",
    "Fox’s cunning: Find/disable traps",
    "Four-leafed clover: Find secret doors",
    "Seventh son: Spell checks",
    "The raging storm: Spell damage",
    "Righteous heart: Turn unholy checks",
    "Survived the plague: Magical healing*",
    "Lucky sign: Saving throws",
    "Guardian angel: Savings throws to escape traps",
    "Survived a spider bite: Saving throws against poison",
    "Struck by lightning: Reflex saving throws",
    "Lived through famine: Fortitude saving throws",
    "Resisted temptation: Willpower saving throws",
    "Charmed house: Armor Class",
    "Speed of the cobra: Initiative",
    "Bountiful harvest: Hit points (applies at each level)",
    "Warrior’s arm: Critical hit tables**",
    "Unholy house: Corruption rolls",
    "The Broken Star: Fumbles**",
    "Birdsong: Number of languages",
    "Wild child: Speed (each +1/-1 = +5’/-5’ speed)"
  ]
  
  // Stat modifiers, indexed by the score value.  Note that the table in the rules goes
  // from 3-18, so additional -3 mods are prepended at positions 0, 1, and 2 to faciliitate
  // simpler logic.
  // Anything below 0 is -3.
  // Anything above 18 follows this formula: floor((value - 18) / 2) + 3
  var modList = [-3, -3, -3, -3, -2, -2, -1, -1, -1, 0, 0, 0, 0, 1, 1, 1, 2, 2, 3];

  // Each of these attributes are input attributes: they are tied to editable inputs on
  // the character sheet.  Nothing should automatically update these attributes.  Rather,
  // if any of them are changed by the user, then the sheet gets recalculated based on
  // the current values of these attributes.
  //
  // Exceptions:
  //  - 'hp': This field must remain in the range [0, hpmax].  If it goes outside that
  //    range, it will be updated to be either 0 (if negative) or hpmax (if greater than
  //    hpmax)
  //  - 'augurroll': Same as HP, but the range is [0, 30].  Note that 0 indicates no
  //    augur has been selected.
  const inputAttributes = [
    "level", "movement",
    "basehp0", "basehp1", "basehp2", "basehp3", "basehp4", "basehp5",
    "basehp6", "basehp7", "basehp8", "basehp9", "basehp10", "hp",
    "augurmod", "augurroll",
    "strengthbase", "staminabase", "agilitybase", "personalitybase", "intelligencebase", "luckbase",
    "strengthbonus", "staminabonus", "agilitybonus", "personalitybonus", "intelligencebonus", "luckbonus",
  ];
  // If any of the above attributes changes, we need to recalculate the sheet.  Additionally,
  // we should recalculate when the sheet is opened too.
  const recalcEvents = inputAttributes.map(attr => `change:${prefix}:${attr}`).join(' ');
  // We also need to retrieve the current values of all of the above attributes to properly
  // recalculate the sheet.
  const inputKeys = inputAttributes.map(attr => `${prefix}_${attr}`);

  // Converts an ability score to the correct modifier.
  function toMod(score) {
    if (score < 0) {
      return modList[0];
    } else if (score > 18) {
      return Math.floor((score - 18) / 2) + 3;
    } else {
      return modList[score];
    }
  }

  // Listener for any of the base attributes changing.  Note that any numbers coming from
  // the |values| object are sanitized using `parseInt(value)||0`.  This ensures they are
  // correctly treated as numbers and not strings.
  //
  // This same technique is not used when retrieving numbers from the |updates| object,
  // because those values get properly sanitized before entering them into the object.
  on(recalcEvents, function () {
    getAttrs(inputKeys, function (values) {
      var updates = {};

      // The very first thing we handle is the birth augur, since this could impact many
      // other parts of the sheet.
      var augur = parseInt(values[`${prefix}_augurroll`])||0;
      var augurMod = parseInt(values[`${prefix}_augurmod`])||0;
      if (augur < 0) {
        augur = 0;
        updates[`${prefix}_augurroll`] = augur;
      } else if (augur > 30) {
        augur = 30;
        updates[`${prefix}_augurroll`] = augur;
      }
      updates[`${prefix}_augur`] = birthAugurs[augur];

      // Recalc the ability scores and modifiers.
      abilityScores.forEach(function (as) {
        var newScore = (parseInt(values[`${prefix}_${as}base`])||0) +
                       (parseInt(values[`${prefix}_${as}bonus`])||0);
        updates[`${prefix}_${as}`] = newScore;
        updates[`${prefix}_${as}mod`] = toMod(newScore);
      });

      // Now that the stamina modifier is known, we can calculate HP.
      updates[`${prefix}_basehptotal`] = [...Array(11).keys()]
                                          .map(i => `${prefix}_basehp${i}`)
                                          .map(key => parseInt(values[key])||0)
                                          .reduce((sum, val) => sum + val);
      var newMaxHp = updates[`${prefix}_basehptotal`] + updates[`${prefix}_staminamod`];
      if (augur == 25) {
        var level = parseInt(values[`${prefix}_level`])||0;
        newMaxHp += augurMod * (level+1)
      }
      if (newMaxHp < 1) { newMaxHp = 1; }
      updates[`${prefix}_hpmax`] = newMaxHp;

      // If the current hp is greater than the new hpmax, reduce hp to match hpmax.
      var current = parseInt(values[`${prefix}_hp`])||0;
      if (current > newMaxHp) { updates[`${prefix}_hp`] = newMaxHp; }
      if (current < 1) { updates[`${prefix}_hp`] = 0; }

      // And we can also update AC and INI based on the agility modifier
      updates[`${prefix}_ac`] = updates[`${prefix}_agilitymod`] + 10;
      if (augur == 23) { updates[`${prefix}_ac`] += augurMod; }

      updates[`${prefix}_initiative`] = updates[`${prefix}_agilitymod`];
      if (augur == 24) { updates[`${prefix}_ac`] += augurMod; }

      // Saves are based on the stamina, agility, and personality modifiers.
      updates[`${prefix}_refsave`] = updates[`${prefix}_agilitymod`];
      if (augur == 17 || augur == 20) { updates[`${prefix}_refsave`] += augurMod; }

      updates[`${prefix}_forsave`] = updates[`${prefix}_staminamod`];
      if (augur == 17 || augur == 21) { updates[`${prefix}_forsave`] += augurMod; }

      updates[`${prefix}_wilsave`] = updates[`${prefix}_personalitymod`];
      if (augur == 17 || augur == 22) { updates[`${prefix}_wilsave`] += augurMod; }

      // Only sheet attribute remaining that the birth augur could affect is movement.
      if (augur == 30) {
        updates[`${prefix}_movement`] = 30 + (augurMod * 5);
      }

      // And finally, we can commit the recalculations.
      setAttrs(updates);
    });
  });

</script>