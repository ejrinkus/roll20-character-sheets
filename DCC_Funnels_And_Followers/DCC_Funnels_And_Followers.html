
<div class="root"><span class="header">Heroes</span>
  <fieldset class="repeating_heroes">
    <div class="hero">
      <div class="hero-name-occ-cell"><span class="block-label">Name</span>
        <input type="text" name="attr_name" value=""/>
      </div>
      <div class="hero-name-occ-cell"><span class="block-label">Occupation</span>
        <input type="text" name="attr_occupation" value=""/>
      </div>
      <div class="hero-class-cell"><span class="block-label">Class</span>
        <input type="text" style="width:133px" name="attr_class" value="None"/>
      </div>
      <div class="hero-level-cell"><span class="block-label">Level</span>
        <input type="number" name="attr_level" value="0"/>
      </div>
      <div class="hero-title-cell"><span class="block-label">Title</span>
        <input type="text" style="width:64px" name="attr_title" value="Peasant"/>
      </div>
      <div class="hero-stat-cell" style="background-image: url('https://raw.githubusercontent.com/ejrinkus/roll20-character-sheets/funnels-and-followers/DCC_Funnels_And_Followers/assets/icons/heart.png')">
        <input class="stat" type="number" name="attr_hp" value="0"/>
        <input class="stat-mod" type="number" name="attr_hpmax" value="0" readonly="readonly"/>
      </div>
      <div class="hero-stat-cell" style="background-image: url('https://raw.githubusercontent.com/ejrinkus/roll20-character-sheets/funnels-and-followers/DCC_Funnels_And_Followers/assets/icons/shield.png')">
        <input class="stat standalone" type="number" name="attr_ac" value="10" readonly="readonly"/>
      </div>
      <div class="hero-stat-cell" style="background-image: url('https://raw.githubusercontent.com/ejrinkus/roll20-character-sheets/funnels-and-followers/DCC_Funnels_And_Followers/assets/icons/movement.png')">
        <input class="stat standalone" type="number" name="attr_movement" value="30" readonly="readonly"/>
      </div>
      <div class="hero-stat-cell" style="background-image: url('https://raw.githubusercontent.com/ejrinkus/roll20-character-sheets/funnels-and-followers/DCC_Funnels_And_Followers/assets/icons/initiative.png')">
        <input class="stat standalone" type="number" name="attr_initiative" value="0" readonly="readonly"/>
      </div>
      <div class="hero-stat-cell" style="background-image: url('https://raw.githubusercontent.com/ejrinkus/roll20-character-sheets/funnels-and-followers/DCC_Funnels_And_Followers/assets/icons/strength.png')">
        <input class="stat" type="number" name="attr_strength" value="0"/>
        <input class="stat-mod" type="number" name="attr_strengthmod" value="0" readonly="readonly"/>
      </div>
      <div class="hero-stat-cell" style="background-image: url('https://raw.githubusercontent.com/ejrinkus/roll20-character-sheets/funnels-and-followers/DCC_Funnels_And_Followers/assets/icons/stamina.png')">
        <input class="stat" type="number" name="attr_stamina" value="0"/>
        <input class="stat-mod" type="number" name="attr_staminamod" value="0" readonly="readonly"/>
      </div>
      <div class="hero-stat-cell" style="background-image: url('https://raw.githubusercontent.com/ejrinkus/roll20-character-sheets/funnels-and-followers/DCC_Funnels_And_Followers/assets/icons/agility.png')">
        <input class="stat" type="number" name="attr_agility" value="0"/>
        <input class="stat-mod" type="number" name="attr_agilitymod" value="0" readonly="readonly"/>
      </div>
      <div class="hero-stat-cell" style="background-image: url('https://raw.githubusercontent.com/ejrinkus/roll20-character-sheets/funnels-and-followers/DCC_Funnels_And_Followers/assets/icons/personality.png')">
        <input class="stat" type="number" name="attr_personality" value="0"/>
        <input class="stat-mod" type="number" name="attr_personalitymod" value="0" readonly="readonly"/>
      </div>
      <div class="hero-stat-cell" style="background-image: url('https://raw.githubusercontent.com/ejrinkus/roll20-character-sheets/funnels-and-followers/DCC_Funnels_And_Followers/assets/icons/intelligence.png')">
        <input class="stat" type="number" name="attr_intelligence" value="0"/>
        <input class="stat-mod" type="number" name="attr_intelligencemod" value="0" readonly="readonly"/>
      </div>
      <div class="hero-stat-cell" style="background-image: url('https://raw.githubusercontent.com/ejrinkus/roll20-character-sheets/funnels-and-followers/DCC_Funnels_And_Followers/assets/icons/luck.png')">
        <input class="stat" type="number" name="attr_luck" value="0"/>
        <input class="stat-mod" type="number" name="attr_luckmod" value="0" readonly="readonly"/>
      </div>
      <div class="hero-label-cell"><span class="block-label">HP</span></div>
      <div class="hero-label-cell"><span class="block-label">AC</span></div>
      <div class="hero-label-cell"><span class="block-label">MOV</span></div>
      <div class="hero-label-cell"><span class="block-label">INI</span></div>
      <div class="hero-label-cell"><span class="block-label">STR</span></div>
      <div class="hero-label-cell"><span class="block-label">STA</span></div>
      <div class="hero-label-cell"><span class="block-label">AGI</span></div>
      <div class="hero-label-cell"><span class="block-label">PER</span></div>
      <div class="hero-label-cell"><span class="block-label">INT</span></div>
      <div class="hero-label-cell"><span class="block-label">LUC</span></div>
      <div class="wrap-hero-details">
        <input class="toggle" type="checkbox"/><span>&nbsp;Details</span>
        <div class="contents">
          <div class="hero-details">
            <div class="hero-details-buttons">
              <button class="details-button" type="action" name="act_selectvitals">Vitals</button>
              <button class="details-button" type="action" name="act_selectinventory">Inventory</button>
              <button class="details-button" type="action" name="act_selectstatus">Status</button>
              <button class="details-button" type="action" name="act_selectabilities">Abilities</button>
              <button class="details-button" type="action" name="act_selectspellcasting">Spellcasting</button>
            </div>
            <input class="toggle" type="hidden" name="attr_selectvitals"/>
            <div class="hero-details-content">
              <div class="vitals"><span class="inline-label vitals-label">Saves:</span>
                <input type="number" name="attr_forsave" value="0" readonly="readonly"/>
                <input type="number" name="attr_refsave" value="0" readonly="readonly"/>
                <input type="number" name="attr_wilsave" value="0" readonly="readonly"/><span class="spacer">&nbsp;</span><span>&nbsp;</span><span>FOR</span><span>REF</span><span>WIL</span><span class="spacer">&nbsp;</span><span class="spacer">&nbsp;</span><span class="inline-label vitals-label">Rolled HP:</span>
                <input type="number" name="attr_basehp0" value="0"/>
                <input type="number" name="attr_basehp1" value="0"/>
                <input type="number" name="attr_basehp2" value="0"/>
                <input type="number" name="attr_basehp3" value="0"/>
                <input type="number" name="attr_basehp4" value="0"/>
                <input type="number" name="attr_basehp5" value="0"/>
                <input type="number" name="attr_basehp6" value="0"/>
                <input type="number" name="attr_basehp7" value="0"/>
                <input type="number" name="attr_basehp8" value="0"/>
                <input type="number" name="attr_basehp9" value="0"/>
                <input type="number" name="attr_basehp10" value="0"/>
                <input type="number" name="attr_basehptotal" value="0" readonly="readonly"/><span>&nbsp;</span><span>Lvl 0</span><span>Lvl 1</span><span>Lvl 2</span><span>Lvl 3</span><span>Lvl 4</span><span>Lvl 5</span><span>Lvl 6</span><span>Lvl 7</span><span>Lvl 8</span><span>Lvl 9</span><span>Lvl 10</span><span>Total</span><span class="spacer">&nbsp;</span><span class="inline-label vitals-label">Birth Augur:</span>
                <input type="number" name="attr_augurmod" value="0"/>
                <input type="number" name="attr_augurroll" value="0"/>
                <input class="augur" type="text" name="attr_augur" value="" readonly="readonly"/><span>&nbsp;</span><span>Mod</span><span>Roll</span>
                <input class="augur-roll" type="hidden" name="attr_augurroll"/><span class="augur-note-if-healing">*If a cleric, applies to all healing the cleric performs.  Otherwise, applies to all magical healing received from other sources.</span><span class="augur-note-if-crit">**Luck normally affects critical hits and fumbles.  On this result, the modifier is doubled for purposes of crits or fumbles.</span><span class="spacer">&nbsp;</span><span class="inline-label vitals-label">Max Scores:</span>
                <input type="number" name="attr_strmax" value="0"/>
                <input type="number" name="attr_stamax" value="0"/>
                <input type="number" name="attr_agimax" value="0"/>
                <input type="number" name="attr_permax" value="0"/>
                <input type="number" name="attr_intmax" value="0"/>
                <input type="number" name="attr_lucmax" value="0"/><span class="spacer">&nbsp;</span><span>&nbsp;</span><span>STR</span><span>STA</span><span>AGI</span><span>PER</span><span>INT</span><span>LUC</span><span class="spacer">&nbsp;</span><span class="spacer">&nbsp;</span>
              </div>
            </div>
            <input class="toggle" type="hidden" name="attr_selectinventory"/>
            <div class="hero-details-content">
              <div class="inventory">TODO: Implement inventory form
                <textarea name="attr_inventoryplaceholder"></textarea>
              </div>
            </div>
            <input class="toggle" type="hidden" name="attr_selectstatus"/>
            <div class="hero-details-content">
              <div class="status">TODO: Implement status form
                <textarea name="attr_statusplaceholder"></textarea>
              </div>
            </div>
            <input class="toggle" type="hidden" name="attr_selectabilities"/>
            <div class="hero-details-content">
              <div class="abilities">TODO: Implement abilities form
                <textarea name="attr_abilitiesplaceholder"></textarea>
              </div>
            </div>
            <input class="toggle" type="hidden" name="attr_selectspellcasting"/>
            <div class="hero-details-content">
              <div class="spells">TODO: Implement spells form
                <textarea name="attr_spellsplaceholder"></textarea>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </fieldset>
</div>
<script type="text/worker">
  
  const fields = ['selectvitals', 'selectinventory', 'selectstatus', 'selectabilities', 'selectspellcasting'];
  on(fields.map(f => `clicked:repeating_heroes:${f}`).join(' '), function(eventInfo) {
      const trigger = eventInfo.sourceAttribute.split('_');
      const thisfield = trigger[3];
      const output = {};
      fields.forEach(f => {
          output['repeating_heroes_' + f] = false;
      });
      output['repeating_heroes_' + thisfield] = true;
      setAttrs(output);
  });
  
  const attributes = ["strength",
    "stamina",
    "agility",
    "personality",
    "intelligence",
    "luck"];
  const attrKeys = attributes.map(attr => `repeating_heroes_${attr}`);
  const attrEvents = attributes.map(attr => `change:repeating_heroes:${attr}`).join(' ') + " sheet:opened";
  const hpKeys = [...Array(11).keys()].map(i => `repeating_heroes_basehp${i}`);
  const hpEvents = [...Array(11).keys()].map(i => `change:repeating_heroes:basehp${i}`).join(' ');
  
  // Stat modifiers, indexed by the score value.  Note that the table in the rules goes
  // from 3-18, so additional -3 mods are prepended at positions 0, 1, and 2 to faciliitate
  // simpler logic.
  // Anything below 0 is -3.
  // Anything above 18 follows this formula: floor((value - 18) / 2) + 3
  var modList = [-3, -3, -3, -3, -2, -2, -1, -1, -1, 0, 0, 0, 0, 1, 1, 1, 2, 2, 3];
  function getMod(attr, values) {
    var value = parseInt(values[`repeating_heroes_${attr}`]) || 0;
    if (value < 0) {
      return modList[0];
    } else if (value > 18) {
      return Math.floor((value - 18) / 2) + 3;
    } else {
      return modList[value];
    }
  }

  // Updates the hp, hpmax, and basehptotal attributes based on the current state of the sheet.
  function updateHp() {
    getAttrs(hpKeys.concat(["repeating_heroes_stamina",
                            "repeating_heroes_hp",
                            "repeating_heroes_hpmax"]), function (values) {
      var updates = {};

      var staMod = getMod("stamina", values);
      var baseTotal = hpKeys.map(key => parseInt(values[key])||0).reduce((sum, val) => sum + val);
      updates["repeating_heroes_basehptotal"] = baseTotal;

      var newMax = baseTotal + staMod;
      if (newMax < 1) newMax = 1;
      updates["repeating_heroes_hpmax"] = newMax;

      var current = parseInt(values["repeating_heroes_hp"]) || 0;
      var oldMax = parseInt(values["repeating_heroes_hpmax"]) || 0;
      current += (newMax - oldMax);
      if (current < 0) current = 0;
      if (current > newMax) current = newMax;
      updates["repeating_heroes_hp"] = current;

      setAttrs(updates);
    });
  }

  // Updates the ac attribute based on the current state of the sheet.
  function updateAc() {
    getAttrs(["repeating_heroes_agility"], function (values) {
      var updates = {};
      updates["repeating_heroes_ac"] = 10 + getMod("agility", values);
      setAttrs(updates);
    });
  }

  // Updates the initiative attribute based on the current state of the sheet.
  function updateIni() {
    getAttrs(["repeating_heroes_agility"], function (values) {
      var updates = {};
      updates["repeating_heroes_initiative"] = getMod("agility", values);
      setAttrs(updates);
    });
  }

  // Updates the three saves based on the current state of the sheet.
  function updateSaves() {
    getAttrs(["repeating_heroes_stamina",
              "repeating_heroes_agility",
              "repeating_heroes_personality"], function (values) {
      var updates = {};
      updates["repeating_heroes_forsave"] = getMod("stamina", values);
      updates["repeating_heroes_refsave"] = getMod("agility", values);
      updates["repeating_heroes_wilsave"] = getMod("personality", values);
      setAttrs(updates);
    });
  }

  // Listener for any of the base attributes changing.
  on(attrEvents, function () {
    getAttrs(attrKeys, function (values) {
      var updates = {};

      // Modifier updates
      attributes.forEach(attr => updates[`repeating_heroes_${attr}mod`] = getMod(attr, values));

      setAttrs(updates);
    });
    updateHp();
    updateAc();
    updateIni();
    updateSaves();
  });

  // Listener for any of the base HP rolls being entered.
  on(hpEvents, function () {
    updateHp();
  });  const birthAugurs = [
    "<-- Enter your birth augur roll",
    "Harsh winter: All attack rolls",
    "The bull: Melee attack rolls",
    "Fortunate date: Missile fire attack rolls",
    "Raised by wolves: Unarmed attack rolls",
    "Conceived on horseback: Mounted attack rolls",
    "Born on the battlefield: Damage rolls",
    "Path of the bear: Melee damage rolls",
    "Hawkeye: Missile fire damage rolls",
    "Pack hunter: Attack and damage rolls for 0-level starting weapon",
    "Born under the loom: Skill checks (including thief skills)",
    "Fox’s cunning: Find/disable traps",
    "Four-leafed clover: Find secret doors",
    "Seventh son: Spell checks",
    "The raging storm: Spell damage",
    "Righteous heart: Turn unholy checks",
    "Survived the plague: Magical healing*",
    "Lucky sign: Saving throws",
    "Guardian angel: Savings throws to escape traps",
    "Survived a spider bite: Saving throws against poison",
    "Struck by lightning: Reflex saving throws",
    "Lived through famine: Fortitude saving throws",
    "Resisted temptation: Willpower saving throws",
    "Charmed house: Armor Class",
    "Speed of the cobra: Initiative",
    "Bountiful harvest: Hit points (applies at each level)",
    "Warrior’s arm: Critical hit tables**",
    "Unholy house: Corruption rolls",
    "The Broken Star: Fumbles**",
    "Birdsong: Number of languages",
    "Wild child: Speed (each +1/-1 = +5’/-5’ speed)"
  ]

  on("change:repeating_heroes:augurroll sheet:opened", function() {
    getAttrs(["repeating_heroes_augurroll"], function(values) {
      var updates = {};
      augur = parseInt(values["repeating_heroes_augurroll"])||0;
      if (augur < 0) {
        augur = 0;
        updates["repeating_heroes_augurroll"] = augur;
      } else if (augur > 30) {
        augur = 30;
        updates["repeating_heroes_augurroll"] = augur;
      }
      updates["repeating_heroes_augur"] = birthAugurs[augur];
      setAttrs(updates);
    });
  });

</script>